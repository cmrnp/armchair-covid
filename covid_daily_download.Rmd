---
title: "COVID-19 daily data download"
author: "Cameron Patrick"
date: "22 September 2021"
output: 
  html_document:
    toc: true
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = TRUE,
  message = TRUE,
  comment = NA
)
```

## Load R packages

```{r packages, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(glue)
library(gt)
```

## Sanity check output file

```{r}
rds_file <- glue("covid19_aus_munged_{Sys.Date()}.Rds")
```

## Data download

Aus data from: <https://github.com/pappubahry/AU_COVID19>

Note NZ file has date in URL! Totals based on notification date don't seem to line up with announcements which are ~ 1pm to 1pm kiwi time. See <https://www.health.govt.nz/our-work/diseases-and-conditions/covid-19-novel-coronavirus/covid-19-data-and-statistics/covid-19-case-demographics>

```{r data-download, warning = FALSE, message = FALSE}
nz_url_date <- "2021-09-22"

covid19_vic <- read_csv("https://github.com/pappubahry/AU_COVID19/raw/master/time_series_vic_sources.csv")
covid19_nsw <- read_csv("https://github.com/pappubahry/AU_COVID19/raw/master/time_series_nsw_sources.csv")
covid19_act <- read_csv("https://github.com/pappubahry/AU_COVID19/raw/master/time_series_act_sources.csv")
covid19_nz <- read_csv(glue("https://www.health.govt.nz/system/files/documents/pages/covid_cases_{nz_url_date}.csv"))
```

## Data wrangling

```{r}
extra_info <- tribble(
  ~state, ~date, ~daily_confirmed,
  "VIC", "2021-09-11", 392,
  "VIC", "2021-09-12", 473,
  "VIC", "2021-09-13", 445,
  "VIC", "2021-09-14", 423,
  "VIC", "2021-09-15", 514,
  "VIC", "2021-09-16", 510,
  "VIC", "2021-09-17", 535,
  "VIC", "2021-09-18", 507,
  "VIC", "2021-09-19", 567,
  "VIC", "2021-09-20", 603,
  "VIC", "2021-09-21", 628,
  "NSW", "2021-09-10", 1599,
  "NSW", "2021-09-11", 1262,
  "NSW", "2021-09-12", 1257,
  "NSW", "2021-09-13", 1127,
  "NSW", "2021-09-14", 1259,
  "NSW", "2021-09-15", 1351,
  "NSW", "2021-09-16", 1284,
  "NSW", "2021-09-17", 1331,
  "NSW", "2021-09-18", 1083,
  "NSW", "2021-09-19", 935,
  "NSW", "2021-09-20", 1022,
  "NSW", "2021-09-21", 1035,
  "ACT", "2021-09-11", 15,
  "ACT", "2021-09-12", 13,
  "ACT", "2021-09-13", 22,
  "ACT", "2021-09-14", 13,
  "ACT", "2021-09-15", 15,
  "ACT", "2021-09-16", 30,
  "ACT", "2021-09-17", 15,
  "ACT", "2021-09-18", 17,
  "ACT", "2021-09-19", 7,
  "ACT", "2021-09-20", 16,
  "ACT", "2021-09-21", 17,
) %>%
  mutate(date = ymd(date))
```

```{r}
outbreak_dates <- tribble(
  ~state, ~outbreak_date,
  "VIC", "2021-07-12",
  "NSW", "2021-06-15",
  "ACT", "2021-08-12",
  "NZ", "2021-08-17",
) %>%
  mutate(outbreak_date = ymd(outbreak_date))
```


```{r data-munge}
selected_states_abbrev <- c("VIC", "NSW", "ACT", "NZ")
selected_states_full <- c("Victoria", "New South Wales", "Australian Capital Territory", "New Zealand")

covid19_aus_munged <- bind_rows(
  "VIC" = covid19_vic %>%
    transmute(date,
              daily_confirmed = local_contact + local_unknown + under_investigation),
  "NSW" = covid19_nsw %>%
    transmute(date = date - 1,
              daily_confirmed = interstate + local_contact + local_unknown + under_investigation),
  "ACT" = covid19_act %>%
    transmute(date,
              daily_confirmed = interstate + local_contact + local_unknown + under_investigation),
  "NZ" = covid19_nz %>%
    filter(`Overseas travel` != "Yes" & `Report Date` < ymd(str_extract(nz_url_date, "^[0-9-]+"))) %>%
    group_by(date = `Report Date`) %>%
    summarise(daily_confirmed = n()),
  .id = "state"
) %>%
  bind_rows(anti_join(extra_info, ., by = c("state", "date"))) %>%
  left_join(outbreak_dates, by = "state") %>%
  group_by(state) %>%
  complete(date = seq(min(date), max(date), by = "day"),
           fill = list(daily_confirmed = 0)) %>%
  ungroup() %>%
  mutate(state = factor(state, levels = selected_states_abbrev),
         state_full = factor(state, levels = selected_states_abbrev, labels = selected_states_full))
```

## Most recent case numbers

```{r}
covid19_aus_munged %>%
  arrange(state, desc(date)) %>%
  group_by(state) %>%
  summarise(head(cur_data(), n = 5)) %>%
  select(state, date, daily_confirmed) %>%
  gt()
```


## Save as R data file

```{r}
saveRDS(covid19_aus_munged, rds_file)
```

## R session info

```{r session-info}
Sys.time()
sessionInfo()
```

